<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="/usr/share/php5/PEAR/data/phing/etc/phing-grammar.rng"
        type="application/xml"
        schematypens="http://relaxng.org/ns/structure/1.0"?>

<project name="Make logic.by" basedir="." default="build">

    <target name="assets">
        <exec executable="php">
            <arg value="-f"/>
            <arg file="public/index.php"/>
            <arg value="--"/>
            <arg value="assetic"/>
            <arg value="build"/>
        </exec>
    </target>

    <target name="classmap" description="Generate classmap">
        <exec command="./vendor/bin/classmap_generator.php --overwrite --library module/Application"/>
        <exec command="./vendor/bin/classmap_generator.php --overwrite --library module/User"/>
        <exec command="./vendor/bin/classmap_generator.php --overwrite --library module/Admin"/>
    </target>

    <target name="phpunit">
        <!--<exec executable="./vendor/bin/phpunit" passthru="true" checkreturn="true">-->
            <!--<arg value="-c"/>-->
            <!--<arg file="module/Application/test/phpunit.xml"/>-->
        <!--</exec>-->
    </target>

    <target name="doctrine-update">
        <exec command="./vendor/bin/doctrine-module orm:clear-cache:metadata"/>
        <exec command="./vendor/bin/doctrine-module orm:clear-cache:query"/>
        <exec command="./vendor/bin/doctrine-module orm:clear-cache:result"/>
        <exec command="./vendor/bin/doctrine-module orm:schema-tool:update --force" passthru="true"/>
    </target>

    <target name="pack" depends="build" description="Pack project into archive">
        <tar basedir="." destfile="deploy.tar.gz">
            <fileset dir=".">
                <include name="module/**"/>
                <include name="config/application.config.php"/>
                <include name="config/autoload/global.php"/>
                <include name="config/autoload/*.global.php"/>
                <include name="composer.json"/>
                <include name="package.json"/>
                <include name="*.php"/>
                <include name="public/index.php"/>
            </fileset>
        </tar>
    </target>

    <target name="clean" description="just clean">
        <delete>
            <fileset dir="public/assets">
                <include name="*.js"/>
                <include name="*.css"/>
            </fileset>
            <fileset dir=".">
                <include name="deploy.tar.gz"/>
            </fileset>
        </delete>
    </target>

    <target name="deploy" depends="pack" description="Deploy to dev server">
        <echo>Not implemented yet</echo>

        <phingcall target="clean"/>
    </target>

    <target name="phpcs">
        <exec command="./vendor/bin/phpcsfixer" passthru="true"/>
    </target>

    <target name="build" depends="classmap, assets"/>
</project>
